version: 2

models:
  - name: int_fact__session
    description: "Final session fact table with deduplicated user IDs, metadata, and campaign codes."
    columns:
      - name: session_id
        description: "Shortened SHA256 session identifier."
        tests: [not_null, unique]
      - name: user_id
        description: "Unified user ID (fallback to session-based ID if unknown)."
        tests:
          - relationships:
              name: fk_user_id_fact_session
              to: ref('int_fact__user')
              field: user_id
      - name: source_platform
        description: "Platform where the session originated."
      - name: session_source_url
        description: "URL that initiated the session."
      - name: code
        description: "QR or campaign code extracted from the session_source_url if available."
      - name: started_at
        description: "Session start timestamp, formatted."
      - name: ended_at
        description: "Session end timestamp, formatted."
      - name: device
        description: "Device used in the session."
      - name: geo_ip
        description: "IP address of the user."
      - name: geo_name
        description: "Location resolved from IP."
      - name: email
        description: "Email of the user if known."
      - name: country
        description: "Country of origin of the user."

  - name: int_fact__user
    description: "Unified user table deduplicating logins from all platforms (WordPress, HelloAsso, social, anonymous)."
    columns:
      - name: user_id
        description: "Shortened and hashed user ID, platform-dependent."
        tests: [not_null, unique]
      - name: login_platform
        description: "Source platform for the login (e.g., helloasso, wordpress)."
      - name: email
        description: "User email if known."
      - name: source_table
        description: "Table the record originates from."
      - name: first_name
        description: "User first name if available."
      - name: last_name
        description: "User last name if available."
      - name: country
        description: "User country if known."
      - name: ingested_at
        description: "Timestamp of user data ingestion."

  - name: int_fact__interaction
    description: "Unified interaction events with user and session details, including QR/campaign code tracking."
    columns:
      - name: interaction_id
        description: "Shortened hashed interaction ID."
        tests: [not_null, unique]
      - name: session_id
        description: "Shortened session ID linked to the interaction."
        tests:
          - relationships:
              name: fk_session_id_fact_interaction
              to: ref('int_fact__session')
              field: session_id
      - name: user_id
        description: "User performing the interaction (if known)."
        tests:
          - relationships:
              name: fk_user_id_fact_interaction
              to: ref('int_fact__user')
              field: user_id
      - name: occurred_at
        description: "Timestamp of the interaction."
      - name: url
        description: "URL where the interaction happened."
      - name: code
        description: "QR code or campaign code extracted from the interaction URL (e.g. ?code=beaubois2025)."
      - name: device
        description: "Device used."
      - name: geo_ip
        description: "IP address used."
      - name: geo_name
        description: "Geo-resolved location."
      - name: ingested_at
        description: "Ingestion timestamp of the interaction."

  - name: int_fact__payment
    description: "Final payments table with normalized values and hashed user_id."
    columns:
      - name: payment_id
        description: "Unique payment identifier."
        tests: [not_null, unique]
      - name: amount
        description: "Amount paid in euros."
      - name: payment_status
        description: "Payment status (e.g., Authorized)."
      - name: payment_date
        description: "Formatted date of payment."
      - name: user_id
        description: "User who made the payment, hashed."
        tests:
          - relationships:
              name: fk_user_id_fact_payment
              to: ref('int_fact__user')
              field: user_id
      - name: payment_type
        description: "Type/source of payment (e.g., HelloAsso)."
      - name: payer_email
        description: "Email of the payer."
      - name: payer_first_name
        description: "Payer first name."
      - name: payer_last_name
        description: "Payer last name."
      - name: payer_country
        description: "Country of the payer."
